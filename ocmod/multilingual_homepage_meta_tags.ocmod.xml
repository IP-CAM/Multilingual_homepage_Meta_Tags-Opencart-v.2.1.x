<?xml version="1.0" encoding="utf-8"?>
<modification>
	<code>multilingual_homepage_meta_tags</code>
	<name>Multilingual Homepage Meta Tags</name>
	<version>1.0.0</version>
	<author>p0v1n0m@gmail.com</author>
	<link>mailto:p0v1n0m@gmail.com</link>
	<file path="admin/model/setting/setting.php">
		<operation>
			<search><![CDATA[
class ModelSettingSetting extends Model {
			]]></search>
			<add position="after"><![CDATA[
	public function getSettingMultilingual($group, $store_id) {
		$this->load->model('localisation/language');

		$languages = $this->model_localisation_language->getLanguages();

		$data = array(); 

		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "setting WHERE store_id = '" . (int)$store_id . "' AND `group` = '" . $this->db->escape($group) . "'");

		foreach ($query->rows as $result) {
			if (!$result['serialized']) {
				$data[$result['key']] = $result['value'];
			} else {
				$data[$result['key']] = unserialize($result['value']);
			}
		}

		foreach ($languages as $language) {
		  foreach ($query->rows as $result) {
			if ('config_meta_title_' . $language['language_id'] == $result['key']) {
				$data['config_meta_title'][$language['language_id']] = $result['value'];
			}

			if ('config_meta_keyword_' . $language['language_id'] == $result['key']) {
				$data['config_meta_keyword'][$language['language_id']] = $result['value'];
			}

			if ('config_meta_description_' . $language['language_id'] == $result['key']) {
				$data['config_meta_description'][$language['language_id']] = $result['value'];
			}
		  }
		}

		return $data;
	}
			]]></add>
		</operation>
	</file>
	<file path="admin/controller/setting/setting.php">
		<operation>
			<search><![CDATA[
if (isset($this->request->post['config_meta_title'])) {
			]]></search>
			<add position="replace" offset="16"><![CDATA[
		$this->load->model('localisation/language');

		$data['languages'] = $this->model_localisation_language->getLanguages();

		foreach ($data['languages'] as $language) {
			if (isset($this->request->post['config_meta_title_' . $language['language_id']])) {
				$data['config_meta_title'][$language['language_id']] = $this->request->post['config_meta_title_' . $language['language_id']];
			} else {
				$data['config_meta_title'][$language['language_id']] = $this->config->get('config_meta_title_' . $language['language_id']);
			}

			if (isset($this->request->post['config_meta_description_' . $language['language_id']])) {
				$data['config_meta_description'][$language['language_id']] = $this->request->post['config_meta_description_' . $language['language_id']];
			} else {
				$data['config_meta_description'][$language['language_id']] = $this->config->get('config_meta_description_' . $language['language_id']);
			}

			if (isset($this->request->post['config_meta_keyword_' . $language['language_id']])) {
				$data['config_meta_keyword'][$language['language_id']] = $this->request->post['config_meta_keyword_' . $language['language_id']];
			} else {
				$data['config_meta_keyword'][$language['language_id']] = $this->config->get('config_meta_keyword_' . $language['language_id']);
			}
		}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[
if (!$this->request->post['config_meta_title']) {
			]]></search>
			<add position="replace" offset="2"><![CDATA[
		$this->load->model('localisation/language');
		
		$data['languages'] = $this->model_localisation_language->getLanguages();
		
		foreach ($data['languages'] as $language) {
			if (!$this->request->post['config_meta_title_' . $language['language_id']]) {
				$this->error['meta_title'] = $this->language->get('error_meta_title');
			}
		}
			]]></add>
		</operation>
	</file>
	<file path="admin/controller/setting/store.php">
		<operation>
			<search><![CDATA[
$store_info = $this->model_setting_setting->getSetting('config', $this->request->get['store_id']);
			]]></search>
			<add position="replace"><![CDATA[
$store_info = $this->model_setting_setting->getSettingMultilingual('config', $this->request->get['store_id']);
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[
if (isset($this->request->post['config_meta_title'])) {
			]]></search>
			<add position="replace" offset="22"><![CDATA[
		$this->load->model('localisation/language');

		$data['languages'] = $this->model_localisation_language->getLanguages();

		foreach ($data['languages'] as $language) {
			if (isset($this->request->post['config_meta_title_' . $language['language_id']])) {
				$data['config_meta_title'][$language['language_id']] = $this->request->post['config_meta_title_' . $language['language_id']];
			} elseif (isset($store_info['config_meta_title'])) {
				$data['config_meta_title'][$language['language_id']] = $store_info['config_meta_title'][$language['language_id']];
			} else {
				$data['config_meta_title'][$language['language_id']] = '';
			}

			if (isset($this->request->post['config_meta_keyword_' . $language['language_id']])) {
				$data['config_meta_keyword'][$language['language_id']] = $this->request->post['config_meta_keyword_' . $language['language_id']];
			} elseif (isset($store_info['config_meta_keyword'])) {
				$data['config_meta_keyword'][$language['language_id']] = $store_info['config_meta_keyword'][$language['language_id']];
			} else {
				$data['config_meta_keyword'][$language['language_id']] = '';
			}

			if (isset($this->request->post['config_meta_description_' . $language['language_id']])) {
				$data['config_meta_description'][$language['language_id']] = $this->request->post['config_meta_description_' . $language['language_id']];
			} elseif (isset($store_info['config_meta_description'])) {
				$data['config_meta_description'][$language['language_id']] = $store_info['config_meta_description'][$language['language_id']];
			} else {
				$data['config_meta_description'][$language['language_id']] = '';
			}
		}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[
if (!$this->request->post['config_meta_title']) {
			]]></search>
			<add position="replace" offset="2"><![CDATA[
		$this->load->model('localisation/language');

		$data['languages'] = $this->model_localisation_language->getLanguages();

		foreach ($data['languages'] as $language) {
			if (!$this->request->post['config_meta_title_' . $language['language_id']]) {
				$this->error['meta_title'] = $this->language->get('error_meta_title');
			}
		}
			]]></add>
		</operation>
	</file>
	<file path="admin/view/template/setting/setting.tpl">
		<operation>
			<search><![CDATA[
<div class="tab-pane active" id="tab-general">
			]]></search>
			<add position="replace" offset="21"><![CDATA[
            <div class="tab-pane active" id="tab-general">
                <div class="form-group required">
                  <label class="col-sm-2 control-label" for="input-meta-title"><?php echo $entry_meta_title; ?></label>
                  <div class="col-sm-10">
				  <?php foreach ($languages as $language) { ?>
					<div class="input-group pull-left">
					<span class="input-group-addon"><img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" /> </span>
                    <input type="text" name="config_meta_title_<?php echo $language['language_id']; ?>" value="<?php echo $config_meta_title[$language['language_id']]; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title_<?php echo $language['language_id']; ?>" class="form-control" />
					</div>
                    <?php if ($error_meta_title) { ?>
                    <div class="text-danger"><?php echo $error_meta_title; ?></div>
                    <?php } ?>
				  <?php } ?>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-sm-2 control-label" for="input-meta-description"><?php echo $entry_meta_description; ?></label>
                  <div class="col-sm-10">
				  <?php foreach ($languages as $language) { ?>
					<div class="input-group pull-left">
					<span class="input-group-addon"><img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" /> </span>
                    <textarea name="config_meta_description_<?php echo $language['language_id']; ?>" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description" class="form-control"><?php echo $config_meta_description[$language['language_id']]; ?></textarea>
					</div>
				  <?php } ?>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-sm-2 control-label" for="input-meta-keyword"><?php echo $entry_meta_keyword; ?></label>
                  <div class="col-sm-10">
				  <?php foreach ($languages as $language) { ?>
					<div class="input-group pull-left">
					<span class="input-group-addon"><img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" /> </span>
                    <textarea name="config_meta_keyword_<?php echo $language['language_id']; ?>" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword" class="form-control"><?php echo $config_meta_keyword[$language['language_id']]; ?></textarea>
					</div>
				  <?php } ?>
                  </div>
                </div>
			]]></add>
		</operation>
	</file>
	<file path="admin/view/template/setting/store_form.tpl">
		<operation>
			<search><![CDATA[
<div class="tab-pane" id="tab-store">
			]]></search>
			<add position="replace" offset="21"><![CDATA[
            <div class="tab-pane" id="tab-store">
                <div class="form-group required">
                  <label class="col-sm-2 control-label" for="input-meta-title"><?php echo $entry_meta_title; ?></label>
                  <div class="col-sm-10">
				  <?php foreach ($languages as $language) { ?>
					<div class="input-group pull-left">
					<span class="input-group-addon"><img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" /> </span>
                    <input type="text" name="config_meta_title_<?php echo $language['language_id']; ?>" value="<?php echo $config_meta_title[$language['language_id']]; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title_<?php echo $language['language_id']; ?>" class="form-control" />
					</div>
                    <?php if ($error_meta_title) { ?>
                    <div class="text-danger"><?php echo $error_meta_title; ?></div>
                    <?php } ?>
				  <?php } ?>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-sm-2 control-label" for="input-meta-description"><?php echo $entry_meta_description; ?></label>
                  <div class="col-sm-10">
				  <?php foreach ($languages as $language) { ?>
					<div class="input-group pull-left">
					<span class="input-group-addon"><img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" /> </span>
                    <textarea name="config_meta_description_<?php echo $language['language_id']; ?>" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description" class="form-control"><?php echo $config_meta_description[$language['language_id']]; ?></textarea>
					</div>
				  <?php } ?>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-sm-2 control-label" for="input-meta-keyword"><?php echo $entry_meta_keyword; ?></label>
                  <div class="col-sm-10">
				  <?php foreach ($languages as $language) { ?>
					<div class="input-group pull-left">
					<span class="input-group-addon"><img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" /> </span>
                    <textarea name="config_meta_keyword_<?php echo $language['language_id']; ?>" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword" class="form-control"><?php echo $config_meta_keyword[$language['language_id']]; ?></textarea>
					</div>
				  <?php } ?>
                  </div>
                </div>
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/common/home.php">
		<operation>
			<search><![CDATA[
public function index() {
			]]></search>
			<add position="after" offset="3"><![CDATA[
		$language_id = $this->config->get('config_language_id');
		$this->document->setTitle($this->config->get('config_meta_title_' . $language_id));
		$this->document->setDescription($this->config->get('config_meta_description_' . $language_id));
		$this->document->setKeywords($this->config->get('config_meta_keyword_' . $language_id));
			]]></add>
		</operation>
	</file>
</modification>
